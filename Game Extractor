import zstandard as zstd
import io
import random
import os

def extract_sample_first_n(zst_path, output_path, max_games=100000, sample_size=10000):
    if not os.path.exists(zst_path):
        print("ERROR: File does not exist. Please check the path.")
        return

    with open(zst_path, 'rb') as compressed_file:
        dctx = zstd.ZstdDecompressor()
        stream_reader = dctx.stream_reader(compressed_file)
        text_stream = io.TextIOWrapper(stream_reader, encoding='utf-8')

        reservoir = []
        current_game = []
        total_games = 0

        for line in text_stream:
            line = line.rstrip('\n\r')
            if not line.strip():
                # Skip empty lines inside games to avoid blank lines inside PGN
                continue

            if line.startswith('[Event '):
                if current_game:
                    game_text = '\n'.join(current_game)
                    reservoir.append(game_text)
                    total_games += 1
                    if total_games >= max_games:
                        break
                    current_game = []
                current_game.append(line)
            else:
                current_game.append(line)

        # Add the last game if exists
        if current_game and total_games < max_games:
            game_text = '\n'.join(current_game)
            reservoir.append(game_text)
            total_games += 1

    print(f"Total games found: {total_games}")

    if total_games == 0:
        print("No games found! Check if the file is a valid .zst compressed PGN file.")
        return

    sample_count = min(sample_size, len(reservoir))
    sampled_games = random.sample(reservoir, sample_count)

    with open(output_path, 'w', encoding='utf-8') as out_file:
        # Exactly one blank line between games
        out_file.write('\n\n'.join(sampled_games))

    print(f"Saved {sample_count} sampled games to {output_path}")


if __name__ == "__main__":
    zst_file = r"ZST FILE LOCATION HERE"
    output_file = "pgns.txt"
    extract_sample_first_n(zst_file, output_file, max_games=1000, sample_size=1000)
